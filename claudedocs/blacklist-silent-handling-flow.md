# 블랙리스트 Silent Handling - 플로우 다이어그램

## 🔄 전체 시스템 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                         사용자 입력                              │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ FormSection Component                                     │  │
│  │ - 이름: "홍길동"                                          │  │
│  │ - 전화번호: "010-1111-2222"                               │  │
│  │ - 이메일: "hong@example.com"                              │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│              POST /api/landing-pages/submit                     │
│                                                                 │
│  Step 1: 필수 필드 검증                                         │
│  ┌────────────────────────────────────────┐                    │
│  │ ✅ landing_page_id 존재?               │                    │
│  │ ✅ name & phone 존재?                  │                    │
│  │ ✅ phone_hash 생성                     │                    │
│  └────────────────────────────────────────┘                    │
│                          │                                      │
│                          ▼                                      │
│  Step 2: 병렬 쿼리 실행 (Promise.all)                          │
│  ┌────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  Query 1: Landing Page 조회                            │   │
│  │  ├─ company_id, status, collect_fields                 │   │
│  │  └─ Time: ~50ms                                        │   │
│  │                                                         │   │
│  │  Query 2: Referrer Company 조회 (optional)             │   │
│  │  ├─ short_id → company UUID 변환                       │   │
│  │  └─ Time: ~50ms                                        │   │
│  │                                                         │   │
│  │  Query 3: 중복 체크                                     │   │
│  │  ├─ phone_hash로 3시간 내 중복 확인                     │   │
│  │  └─ Time: ~50ms                                        │   │
│  │                                                         │   │
│  │  Query 4: 🚨 블랙리스트 체크                            │   │
│  │  ├─ phone_number 정확히 일치 확인                       │   │
│  │  └─ Time: ~50ms                                        │   │
│  │                                                         │   │
│  └─────────────────────┬──────────────────────────────────┘   │
│                        │                                        │
│                        ▼                                        │
│  Step 3: 결과 분석 및 분기                                      │
│                                                                 │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
              ┌───────────┴───────────┐
              │                       │
         ❌ 블랙리스트            ✅ 정상 번호
           발견됨
              │                       │
              ▼                       ▼
┌─────────────────────────┐  ┌────────────────────────┐
│ Silent Handling Path    │  │ Normal Processing Path │
│ (변경 후 새로운 로직)    │  │ (기존 로직 유지)        │
└─────────────────────────┘  └────────────────────────┘
              │                       │
              │                       │
              ▼                       ▼
┌─────────────────────────┐  ┌────────────────────────┐
│ 1. 로그 기록             │  │ 1. 중복 체크            │
│ console.log({           │  │    ├─ 중복 → 409 에러  │
│   event: 'BLACKLIST..', │  │    └─ 정상 → 다음 단계 │
│   masked_phone,         │  │                        │
│   landing_page_id,      │  │ 2. Custom Fields 추출  │
│   timestamp             │  │    └─ collect_fields 기반│
│ })                      │  │                        │
│                         │  │ 3. DB INSERT           │
│ 2. DB 저장 ❌ 스킵      │  │ ┌──────────────────┐   │
│    (아무것도 안 함)      │  │ │ INSERT INTO leads│   │
│                         │  │ │ - company_id     │   │
│ 3. 성공 응답 반환        │  │ │ - name, phone    │   │
│ return {                │  │ │ - phone_hash     │   │
│   success: true,        │  │ │ - custom_fields  │   │
│   data: {               │  │ │ - utm_params     │   │
│     lead_id: null,      │  │ │ - device_type    │   │
│     message: '신청...'  │  │ │ ...              │   │
│   }                     │  │ └──────────────────┘   │
│ }                       │  │    └─ Time: ~100ms     │
│                         │  │                        │
│ ⚡ 응답 시간: ~100ms     │  │ 4. Count 증가 (비동기)  │
│   (DB 저장 안 해서 빠름) │  │ submissions_count++    │
│                         │  │                        │
│                         │  │ 5. 성공 응답 반환       │
│                         │  │ return {               │
│                         │  │   success: true,       │
│                         │  │   data: {              │
│                         │  │     lead_id: "uuid",   │
│                         │  │     message: '신청...' │
│                         │  │   }                    │
│                         │  │ }                      │
│                         │  │                        │
│                         │  │ ⚡ 응답 시간: ~200ms    │
└─────────┬───────────────┘  └────────┬───────────────┘
          │                           │
          │                           │
          └───────────┬───────────────┘
                      │
                      ▼
          ┌───────────────────────┐
          │   200 OK Response     │
          │   {                   │
          │     success: true,    │
          │     data: {           │
          │       lead_id: ...,   │
          │       message: ...    │
          │     }                 │
          │   }                   │
          └───────────┬───────────┘
                      │
                      ▼
          ┌───────────────────────┐
          │  FormSection Component│
          │                       │
          │  setSubmitted(true)   │
          └───────────┬───────────┘
                      │
                      ▼
          ┌───────────────────────┐
          │   ✅ 성공 화면 표시    │
          │                       │
          │  "신청 완료!"         │
          │  "신청이 완료되었습니다"│
          │                       │
          │  (블랙리스트 여부와   │
          │   관계없이 동일)      │
          └───────────────────────┘
```

## 🔍 상세 비교: 변경 전 vs 변경 후

### 시나리오 1: 블랙리스트 번호 제출

#### ❌ 변경 전 (현재)
```
사용자 입력: 010-1111-2222 (블랙리스트)
    ↓
API 병렬 쿼리
    ↓
블랙리스트 발견
    ↓
❌ 403 Forbidden 반환
{
  error: {
    message: '등록할 수 없는 전화번호입니다'
  }
}
    ↓
FormSection: error 상태 설정
    ↓
🚨 에러 메시지 표시
┌─────────────────────────────────┐
│ ⚠️ 등록할 수 없는 전화번호입니다 │
└─────────────────────────────────┘

문제점:
1. 사용자가 블랙리스트임을 알게 됨 → 우회 시도 가능
2. 부정적인 UX (에러 메시지)
3. 브랜드 이미지 손상 가능
```

#### ✅ 변경 후 (새로운 설계)
```
사용자 입력: 010-1111-2222 (블랙리스트)
    ↓
API 병렬 쿼리
    ↓
블랙리스트 발견
    ↓
서버 로그 기록 (마스킹)
console.log({
  event: 'BLACKLIST_SUBMISSION_BLOCKED',
  masked_phone: '010-1111-****',
  landing_page_id: '...',
  timestamp: '...'
})
    ↓
DB 저장 스킵 (아무것도 안 함)
    ↓
✅ 200 OK 반환
{
  success: true,
  data: {
    lead_id: null,
    message: '신청이 완료되었습니다'
  }
}
    ↓
FormSection: submitted 상태 설정
    ↓
✅ 성공 메시지 표시
┌─────────────────────────────────┐
│ ✅ 신청 완료!                    │
│ 신청이 완료되었습니다.           │
│ 빠른 시일 내에 연락드리겠습니다. │
└─────────────────────────────────┘

장점:
1. 사용자는 블랙리스트임을 모름 → 우회 시도 불가
2. 긍정적인 UX (성공 메시지)
3. 브랜드 이미지 유지
4. 관리자는 로그로 추적 가능
```

### 시나리오 2: 정상 번호 제출

#### ✅ 변경 전/후 동일 (변경 없음)
```
사용자 입력: 010-2222-3333 (정상)
    ↓
API 병렬 쿼리
    ↓
블랙리스트 미발견
    ↓
중복 체크 통과
    ↓
DB INSERT (leads 테이블)
    ↓
submissions_count 증가
    ↓
✅ 200 OK 반환
{
  success: true,
  data: {
    lead_id: 'actual-uuid-here',
    message: '신청이 완료되었습니다'
  }
}
    ↓
✅ 성공 메시지 표시 (동일)
```

## 📊 데이터베이스 영향 분석

### Case 1: 블랙리스트 번호 (010-1111-2222)

```sql
-- 변경 전: DB에 저장 안 됨 (403 에러로 차단)
SELECT * FROM leads WHERE phone = '010-1111-2222';
-- 결과: 0 rows

SELECT * FROM landing_pages WHERE id = '...';
-- submissions_count: 변화 없음

-- 변경 후: DB에 저장 안 됨 (Silent handling)
SELECT * FROM leads WHERE phone = '010-1111-2222';
-- 결과: 0 rows (동일)

SELECT * FROM landing_pages WHERE id = '...';
-- submissions_count: 변화 없음 (동일)

✅ DB 상태 동일 (차이 없음)
```

### Case 2: 정상 번호 (010-2222-3333)

```sql
-- 변경 전: DB에 정상 저장
SELECT * FROM leads WHERE phone = '010-2222-3333';
-- 결과: 1 row (lead_id, name, phone, etc.)

-- 변경 후: DB에 정상 저장 (동일)
SELECT * FROM leads WHERE phone = '010-2222-3333';
-- 결과: 1 row (lead_id, name, phone, etc.)

✅ 정상 동작 유지
```

## 🔐 보안 및 개인정보 보호

### 1. 서버 로그 마스킹
```typescript
// ❌ 나쁜 예: 전화번호 전체 노출
console.log('Blocked phone:', '010-1111-2222')

// ✅ 좋은 예: 뒷자리 마스킹
console.log('Blocked phone:', '010-1111-****')
```

### 2. 클라이언트 정보 노출 방지
```typescript
// ❌ 나쁜 예: 403 에러로 블랙리스트 여부 노출
return NextResponse.json(
  { error: { message: '등록할 수 없는 전화번호입니다' } },
  { status: 403 }
)
// → 사용자가 "내 번호가 블랙리스트구나" 알게 됨

// ✅ 좋은 예: 200 성공으로 블랙리스트 여부 숨김
return NextResponse.json({
  success: true,
  data: { message: '신청이 완료되었습니다' }
})
// → 사용자는 정상 제출로 인식
```

### 3. 로그 접근 권한
- 서버 로그는 관리자만 접근 가능
- CloudWatch/Datadog 등 보안 로깅 시스템 사용
- 로그 보존 기간: 90일 (개인정보보호법 준수)

## 📈 성능 및 비용 분석

### 응답 시간 비교
```
┌──────────────────────┬─────────┬─────────┐
│ 시나리오              │ 변경 전 │ 변경 후 │
├──────────────────────┼─────────┼─────────┤
│ 블랙리스트 번호 제출 │ ~100ms  │ ~100ms  │
│ (병렬 쿼리만 실행)    │ (403)   │ (200)   │
├──────────────────────┼─────────┼─────────┤
│ 정상 번호 제출        │ ~200ms  │ ~200ms  │
│ (DB 저장 포함)        │ (200)   │ (200)   │
└──────────────────────┴─────────┴─────────┘

✅ 성능 영향: 없음 (동일)
```

### DB 쓰기 작업 비교
```
시나리오: 블랙리스트 번호 100건 제출

변경 전:
- DB INSERT: 0건 (403 에러로 차단)
- DB UPDATE: 0건

변경 후:
- DB INSERT: 0건 (Silent handling)
- DB UPDATE: 0건

✅ DB 비용 절감: 변경 없음 (이미 최적화됨)
```

## 🎯 핵심 설계 포인트

### 1. **사용자에게 동일한 성공 경험 제공**
```
블랙리스트 여부와 무관하게:
✅ 200 OK 응답
✅ "신청이 완료되었습니다" 메시지
✅ 동일한 성공 화면
```

### 2. **서버에서만 블랙리스트 관리**
```
클라이언트 (FormSection.tsx):
- 블랙리스트 체크 로직 없음
- 단순히 API 응답 처리만

서버 (submit/route.ts):
- 블랙리스트 체크 수행
- Silent handling 결정
- 로그 기록
```

### 3. **관리자는 완전한 가시성 확보**
```
서버 로그:
{
  event: 'BLACKLIST_SUBMISSION_BLOCKED',
  masked_phone: '010-****-1234',
  landing_page_id: '...',
  company_id: '...',
  timestamp: '...',
  ip_address: '...',
  user_agent: '...'
}

활용:
- 블랙리스트 효과 측정
- 악의적 패턴 탐지
- 블랙리스트 관리 개선
```

---

**다이어그램 버전**: 1.0
**작성일**: 2025-02-24
**작성자**: Claude Code
