# DB 블랙리스트 기능 설계 문서

## 개요

랜딩페이지에서 악의적으로 반복 제출하는 전화번호를 차단하여 DB의 신뢰도를 보호하는 기능입니다.

## 목적

- 스팸 전화번호로부터 DB 보호
- 악의적인 리드 생성 방지
- DB 품질 및 신뢰도 유지

## 핵심 기능

### 1. 블랙리스트 관리
- 관리자 전용 블랙리스트 페이지 (`/dashboard/blacklist`)
- 전화번호 추가/삭제 기능
- 차단 사유 기록

### 2. 리드 생성 차단
- 랜딩페이지 제출 시 블랙리스트 자동 체크
- 블랙리스트 번호는 DB에 저장되지 않음
- 사용자에게 일반적인 오류 메시지 표시 (보안상 블랙리스트 여부 노출 안 함)

## 데이터베이스 스키마

### `phone_blacklist` 테이블

```sql
CREATE TABLE phone_blacklist (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone_number VARCHAR(20) NOT NULL UNIQUE,
  reason TEXT,
  blocked_at TIMESTAMPTZ DEFAULT NOW(),
  blocked_by_user_id UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**필드 설명**:
- `phone_number`: 차단할 전화번호 (숫자만, 암호화되지 않음)
- `reason`: 차단 사유 (선택사항)
- `blocked_by_user_id`: 차단 처리한 관리자 ID
- `blocked_at`: 차단 시각

**인덱스**:
- `idx_phone_blacklist_phone`: 전화번호 빠른 검색
- `idx_phone_blacklist_blocked_at`: 최신 차단 순 정렬

**RLS 정책**:
- 관리자만 조회/추가/삭제 가능
- `is_super_admin = true` 권한 필요

## API 엔드포인트

### POST `/api/dashboard/blacklist`
블랙리스트에 전화번호 추가

**요청**:
```json
{
  "phone_number": "010-1234-5678",
  "reason": "스팸 의심",
  "blocked_by_user_id": "uuid"
}
```

**응답**:
```json
{
  "id": "uuid",
  "phone_number": "01012345678",
  "reason": "스팸 의심",
  "blocked_at": "2025-12-24T00:00:00Z",
  "blocked_by": {
    "full_name": "관리자"
  }
}
```

**에러**:
- `409`: 이미 블랙리스트에 등록된 번호
- `403`: 관리자 권한 없음
- `401`: 인증 안 됨

### DELETE `/api/dashboard/blacklist/[id]`
블랙리스트에서 전화번호 제거

**응답**:
```json
{
  "success": true
}
```

**에러**:
- `403`: 관리자 권한 없음
- `401`: 인증 안 됨

## 랜딩페이지 통합

### 제출 프로세스

1. **병렬 검증** (성능 최적화):
   ```typescript
   const [
     { data: landingPage },
     { data: referrerCompany },
     { data: existingLead },
     { data: blacklistedPhone }  // 블랙리스트 체크 추가
   ] = await Promise.all([...])
   ```

2. **블랙리스트 체크**:
   - 전화번호 정규화 (숫자만 추출)
   - `phone_blacklist` 테이블에서 검색
   - 발견 시 `403 Forbidden` 반환

3. **오류 메시지**:
   ```json
   {
     "error": {
       "message": "등록할 수 없는 전화번호입니다"
     }
   }
   ```

   > **보안**: 블랙리스트 여부를 명시하지 않아 악의적 사용자가 우회 시도를 막음

## UI/UX 디자인

### 블랙리스트 페이지

**레이아웃**:
- 기존 대시보드 페이지와 동일한 디자인
- 헤더: 제목 + 설명 + 추가하기 버튼
- 테이블: NO, 등록 날짜, 전화번호, 비고, 삭제 버튼

**테이블 구조**:
```
┌─────┬──────────────┬──────────────┬──────────────┬────────┐
│ NO. │ 등록 날짜    │ 전화번호     │ 비고         │ 삭제   │
├─────┼──────────────┼──────────────┼──────────────┼────────┤
│ 10  │ 2025-12-08   │ 010-1111-1111│ 테스트 필드  │ [삭제] │
│  9  │ 2025-12-01   │ 010-2222-2222│              │ [삭제] │
└─────┴──────────────┴──────────────┴──────────────┴────────┘
```

### 추가 모달

**필드**:
1. **전화번호** (필수):
   - 입력 형식: `010-1234-5678`
   - 자동 정규화: 숫자만 저장

2. **비고** (선택):
   - 다중 행 텍스트 입력
   - 차단 사유 기록

**버튼**:
- 추가하기 (파란색, 우측)
- 취소 (회색, 좌측)

## 사이드바 네비게이션

**위치**: 설정 섹션 하단

**아이콘**: `ShieldExclamationIcon` (경고 방패)

**메뉴 항목**:
```tsx
{
  name: 'DB 블랙리스트',
  href: '/dashboard/blacklist',
  icon: ShieldExclamationIcon
}
```

## 권한 관리

**접근 권한**:
- `is_super_admin = true` 필요
- 일반 사용자는 접근 불가 (대시보드로 리다이렉트)

**RLS 정책**:
- 블랙리스트 테이블은 관리자만 CRUD 가능
- 서비스 롤 클라이언트는 읽기만 가능 (랜딩페이지 체크용)

## 보안 고려사항

### 1. 전화번호 보안
- 블랙리스트는 **암호화하지 않음** (빠른 검색 위해)
- 일반 리드 테이블은 암호화 유지
- 관리자만 접근 가능하도록 RLS 적용

### 2. 정보 노출 방지
- 블랙리스트 여부를 사용자에게 알리지 않음
- 일반적인 오류 메시지로 위장
- 로그에만 블랙리스트 차단 기록

### 3. 우회 시도 방지
- 전화번호 정규화 (하이픈, 공백 제거)
- 숫자만 비교하여 형식 변경 우회 방지

## 성능 최적화

### 1. 병렬 쿼리 실행
```typescript
// 블랙리스트 체크를 다른 검증과 병렬로 실행
await Promise.all([
  landingPageQuery,
  referrerQuery,
  duplicateCheckQuery,
  blacklistCheckQuery  // 추가
])
```

### 2. 인덱스 활용
- `phone_number` 컬럼에 인덱스 생성
- 빠른 검색 및 중복 체크

### 3. 캐싱 고려사항
- 블랙리스트는 자주 변경되지 않으므로 캐싱 가능
- Redis 등으로 성능 개선 여지 있음 (향후 개선 사항)

## 테스트 시나리오

### 1. 블랙리스트 추가
- [x] 관리자가 전화번호 추가
- [x] 중복 전화번호 추가 시 오류
- [x] 일반 사용자 접근 차단

### 2. 블랙리스트 삭제
- [x] 관리자가 전화번호 삭제
- [x] 삭제 후 랜딩페이지 제출 가능

### 3. 랜딩페이지 제출
- [x] 블랙리스트 번호로 제출 시 차단
- [x] 일반 번호는 정상 제출
- [x] 오류 메시지가 보안상 적절한지 확인

### 4. 권한 테스트
- [x] 관리자만 블랙리스트 페이지 접근
- [x] 일반 사용자는 대시보드로 리다이렉트

## 향후 개선 사항

### 1. 대량 등록
- CSV 파일로 대량 블랙리스트 등록
- Excel 업로드 기능

### 2. 패턴 기반 차단
- 특정 번호 패턴 차단 (예: 010-1111-xxxx)
- 정규표현식 지원

### 3. 자동 블랙리스트
- 일정 시간 내 N회 이상 제출 시 자동 블랙리스트
- AI 기반 스팸 감지

### 4. 통계
- 블랙리스트 차단 횟수 집계
- 차단된 제출 시도 통계

## 구현 체크리스트

- [x] 데이터베이스 마이그레이션 생성
- [x] 사이드바에 네비게이션 추가
- [x] 블랙리스트 페이지 생성
- [x] 추가 모달 컴포넌트
- [x] 블랙리스트 API 엔드포인트
- [x] 랜딩페이지 API 통합
- [x] 설계 문서 작성
- [ ] 마이그레이션 실행
- [ ] 프로덕션 배포
- [ ] 기능 테스트

## 배포 절차

1. **데이터베이스 마이그레이션**:
   ```bash
   # Supabase SQL Editor에서 실행
   supabase/migrations/20251224000002_create_phone_blacklist.sql
   ```

2. **애플리케이션 배포**:
   ```bash
   git add .
   git commit -m "feat: DB 블랙리스트 기능 구현"
   git push origin main
   ```

3. **검증**:
   - 블랙리스트 페이지 접근 확인
   - 전화번호 추가/삭제 테스트
   - 랜딩페이지 제출 차단 테스트

---

**작성일**: 2025-12-24
**작성자**: Claude Sonnet 4.5
**버전**: 1.0
